<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feedback Insights - Cloudflare</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --cf-orange: #F6821F;
      --cf-orange-dark: #E6730F;
      --cf-orange-light: #FF9A3C;
      --cf-orange-lighter: #FFB366;
      --cf-orange-lightest: #FFE5CC;
      --bg-primary: #FFFFFF;
      --bg-secondary: #F8F9FA;
      --bg-card: #FFFFFF;
      --text-primary: #1A1A1A;
      --text-secondary: #6B7280;
      --border-color: #E5E7EB;
      --success: #10B981;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Header */
    .header {
      background: var(--bg-primary);
      padding: 20px 24px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
      border-radius: 12px;
    }

    .header h1 {
      font-size: 32px;
      font-weight: 700;
      color: var(--cf-orange);
      margin-bottom: 8px;
    }

    .header-subtitle {
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* Filters Section */
    .filters-section {
      background: var(--bg-card);
      padding: 24px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 0;
    }

    .filters-row {
      display: flex;
      align-items: flex-end;
      gap: 16px;
      flex-wrap: wrap;
    }

    .filters-row .filters-grid {
      flex: 1;
      min-width: 0;
    }

    .filters-row .btn-primary {
      margin-bottom: 0;
      white-space: nowrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-group label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .filter-group select,
    .filter-group input {
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: all 0.2s;
    }

    .filter-group select:focus,
    .filter-group input[type="text"]:focus,
    .filter-group input[type="date"]:focus {
      outline: none;
      border-color: var(--cf-orange);
      box-shadow: 0 0 0 3px var(--cf-orange-lightest);
    }

    /* Multi-select dropdown */
    .multi-select-wrapper {
      position: relative;
    }

    .multi-select-display {
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
      background: var(--bg-primary);
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
      min-height: 42px;
    }

    .multi-select-display:hover {
      border-color: var(--cf-orange);
    }

    .multi-select-display:focus {
      outline: none;
      border-color: var(--cf-orange);
      box-shadow: 0 0 0 3px var(--cf-orange-lightest);
    }

    .multi-select-display::after {
      content: '‚ñº';
      font-size: 10px;
      color: var(--text-secondary);
      margin-left: 8px;
    }

    .multi-select-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      margin-top: 4px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
    }

    .multi-select-dropdown.active {
      display: block;
    }

    .multi-select-option {
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .multi-select-option:hover {
      background: var(--bg-secondary);
    }

    .multi-select-option input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--cf-orange);
    }

    .multi-select-option label {
      cursor: pointer;
      flex: 1;
      margin: 0;
      font-size: 14px;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--cf-orange);
      color: white;
    }

    .btn-primary:hover {
      background: var(--cf-orange-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--border-color);
    }

    .btn-ai {
      background: linear-gradient(135deg, var(--cf-orange) 0%, var(--cf-orange-light) 100%);
      color: white;
    }

    .btn-ai:hover {
      background: linear-gradient(135deg, var(--cf-orange-dark) 0%, var(--cf-orange) 100%);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    /* Stats Overview */
    .stats-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--bg-card);
      padding: 24px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--cf-orange);
    }

    .stat-card h3 {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .stat-card .change {
      font-size: 14px;
      color: var(--success);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* Charts Grid */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
      margin-bottom: 24px;
    }

    .chart-card {
      background: var(--bg-card);
      padding: 24px;
      border-radius: 12px;
      box-shadow: var(--shadow);
    }

    .chart-card.full-width {
      grid-column: 1 / -1;
    }

    .chart-card h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chart-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }

    .chart-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn-icon {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-size: 16px;
    }

    .btn-icon:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .btn-icon:active {
      transform: scale(0.95);
    }

    .chart-card .subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    .chart-container {
      position: relative;
      height: 300px;
    }

    .chart-container.large {
      height: 400px;
    }

    /* AI Advice Section */
    .ai-advice-section {
      background: linear-gradient(135deg, var(--cf-orange-lightest) 0%, #FFFFFF 100%);
      padding: 24px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
      border: 1px solid var(--cf-orange-lighter);
      display: none;
    }

    .ai-advice-section.active {
      display: block;
    }

    .ai-advice-section h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .ai-advice-section .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .ai-advice-section .close-btn:hover {
      background: rgba(0, 0, 0, 0.05);
      color: var(--text-primary);
    }

    .ai-advice-section .advice-content {
      background: white;
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid var(--cf-orange);
    }

    .ai-advice-section .advice-item {
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .ai-advice-section .advice-item:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .ai-advice-section .advice-item strong {
      color: var(--cf-orange);
      display: block;
      margin-bottom: 4px;
    }

    /* Loading State */
    .loading {
      display: none;
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 3px solid var(--cf-orange-lightest);
      border-top: 3px solid var(--cf-orange);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }


    /* Toast notification animations */
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }

      .filters-grid {
        grid-template-columns: 1fr;
      }

    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>Feedback Insights</h1>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
      <div class="filters-row">
        <div class="filters-grid">
          <div class="filter-group">
            <label>Product</label>
            <div class="multi-select-wrapper">
              <div class="multi-select-display" id="productDisplay" onclick="toggleMultiSelect('product')">
                <span id="productDisplayText">All Products</span>
              </div>
              <div class="multi-select-dropdown" id="productDropdown">
                <div class="multi-select-option">
                  <input type="checkbox" id="product_Workers" name="product" value="Workers" onchange="updateMultiSelect('product')">
                  <label for="product_Workers">Workers</label>
                </div>
                <div class="multi-select-option">
                  <input type="checkbox" id="product_D1" name="product" value="D1" onchange="updateMultiSelect('product')">
                  <label for="product_D1">D1</label>
                </div>
                <div class="multi-select-option">
                  <input type="checkbox" id="product_R2" name="product" value="R2" onchange="updateMultiSelect('product')">
                  <label for="product_R2">R2</label>
                </div>
                <div class="multi-select-option">
                  <input type="checkbox" id="product_WAF" name="product" value="WAF" onchange="updateMultiSelect('product')">
                  <label for="product_WAF">WAF</label>
                </div>
                <div class="multi-select-option">
                  <input type="checkbox" id="product_WorkersAI" name="product" value="Workers AI" onchange="updateMultiSelect('product')">
                  <label for="product_WorkersAI">Workers AI</label>
                </div>
                <div class="multi-select-option">
                  <input type="checkbox" id="product_Pages" name="product" value="Pages" onchange="updateMultiSelect('product')">
                  <label for="product_Pages">Pages</label>
                </div>
              </div>
            </div>
          </div>
          <div class="filter-group">
            <label>Platform</label>
            <div class="multi-select-wrapper">
              <div class="multi-select-display" id="platformDisplay" onclick="toggleMultiSelect('platform')">
                <span id="platformDisplayText">All Platforms</span>
              </div>
              <div class="multi-select-dropdown" id="platformDropdown">
                <div class="multi-select-option">
                  <input type="checkbox" id="platform_support" name="platform" value="support_ticket" onchange="updateMultiSelect('platform')">
                  <label for="platform_support">Support Tickets</label>
                </div>
                <div class="multi-select-option">
                  <input type="checkbox" id="platform_github" name="platform" value="github_issue" onchange="updateMultiSelect('platform')">
                  <label for="platform_github">GitHub</label>
                </div>
                <div class="multi-select-option">
                  <input type="checkbox" id="platform_discord" name="platform" value="community_discord" onchange="updateMultiSelect('platform')">
                  <label for="platform_discord">Community Discord</label>
                </div>
                <div class="multi-select-option">
                  <input type="checkbox" id="platform_email" name="platform" value="email_feedback" onchange="updateMultiSelect('platform')">
                  <label for="platform_email">Email</label>
                </div>
                <div class="multi-select-option">
                  <input type="checkbox" id="platform_twitter" name="platform" value="twitter" onchange="updateMultiSelect('platform')">
                  <label for="platform_twitter">Twitter</label>
                </div>
              </div>
            </div>
          </div>
          <div class="filter-group">
            <label>Country</label>
            <div class="multi-select-wrapper">
              <div class="multi-select-display" id="countryDisplay" onclick="toggleMultiSelect('country')">
                <span id="countryDisplayText">All Countries</span>
              </div>
              <div class="multi-select-dropdown" id="countryDropdown">
                <div class="multi-select-option">
                  <input type="checkbox" id="country_US" name="country" value="US" onchange="updateMultiSelect('country')">
                  <label for="country_US">United States</label>
                </div>
                <div class="multi-select-option">
                  <input type="checkbox" id="country_UK" name="country" value="UK" onchange="updateMultiSelect('country')">
                  <label for="country_UK">United Kingdom</label>
                </div>
                <div class="multi-select-option">
                  <input type="checkbox" id="country_DE" name="country" value="DE" onchange="updateMultiSelect('country')">
                  <label for="country_DE">Germany</label>
                </div>
                <div class="multi-select-option">
                  <input type="checkbox" id="country_JP" name="country" value="JP" onchange="updateMultiSelect('country')">
                  <label for="country_JP">Japan</label>
                </div>
                <div class="multi-select-option">
                  <input type="checkbox" id="country_TW" name="country" value="TW" onchange="updateMultiSelect('country')">
                  <label for="country_TW">Taiwan</label>
                </div>
                <div class="multi-select-option">
                  <input type="checkbox" id="country_IN" name="country" value="IN" onchange="updateMultiSelect('country')">
                  <label for="country_IN">India</label>
                </div>
              </div>
            </div>
          </div>
          <div class="filter-group">
            <label>Time Range</label>
            <select id="filterTimeRange">
              <option value="7">Last 7 days</option>
              <option value="30" selected>Last 30 days</option>
              <option value="90">Last 90 days</option>
              <option value="365">Last year</option>
              <option value="all">All time</option>
            </select>
          </div>
        </div>
        <button class="btn btn-primary" id="btnApplyFilters">
          <span>Apply Filters</span>
        </button>
      </div>
      <div class="action-buttons">
        <button class="btn btn-secondary" id="btnSaveView">
          <span>üíæ Save View</span>
        </button>
        <button class="btn btn-secondary" id="btnShare">
          <span>üîó Share Link</span>
        </button>
        <button class="btn btn-ai" id="btnAIAdvice">
          <span>ü§ñ Get AI Advice</span>
        </button>
      </div>
    </div>


    <!-- Loading State -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Analyzing feedback data...</p>
    </div>

    <!-- AI Advice Section -->
    <div class="ai-advice-section" id="aiAdviceSection">
      <h3>
        <span>ü§ñ AI Recommendations</span>
        <button class="close-btn" id="btnCloseAI" aria-label="Close">√ó</button>
      </h3>
      <div class="advice-content" id="aiAdviceContent">
        <!-- AI advice will be populated here -->
      </div>
    </div>


    <!-- Stats Overview -->
    <div class="stats-overview" id="statsOverview">
      <!-- Stats will be populated here -->
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid" id="chartsGrid">
      <!-- Charts will be populated here -->
    </div>
  </div>

  <script>
    // Mock data generator
    const generateMockData = (filters) => {
      const products = ['Workers', 'D1', 'R2', 'WAF', 'Workers AI', 'Pages'];
      const platforms = ['support_ticket', 'github_issue', 'community_discord', 'email_feedback', 'twitter'];
      const countries = ['US', 'UK', 'DE', 'JP', 'TW', 'IN'];
      const themes = [
        'Performance Issues',
        'Documentation Requests',
        'Feature Requests',
        'Bug Reports',
        'Pricing Concerns',
        'Integration Problems',
        'Security Questions',
        'Migration Support',
        'API Improvements',
        'User Experience'
      ];
      const sentiments = ['positive', 'neutral', 'negative'];
      const urgencies = ['low', 'medium', 'high', 'critical'];
      const values = ['low', 'medium', 'high'];

      // Filter logic
      const filteredProducts = filters.product ? [filters.product] : products;
      const filteredPlatforms = filters.platform ? [filters.platform] : platforms;
      const filteredCountries = filters.country ? [filters.country] : countries;

      // Generate data based on filters
      const totalCount = Math.floor(Math.random() * 5000) + 2000;
      
      const byTheme = themes.map(theme => ({
        key: theme,
        count: Math.floor(Math.random() * 500) + 50
      })).sort((a, b) => b.count - a.count);

      const byPlatform = filteredPlatforms.map(platform => ({
        key: platform,
        count: Math.floor(Math.random() * 800) + 100
      }));

      const byCountry = filteredCountries.map(country => ({
        key: country,
        count: Math.floor(Math.random() * 600) + 50
      }));

      const byProduct = filteredProducts.map(product => ({
        key: product,
        count: Math.floor(Math.random() * 700) + 100
      }));

      const byTime = Array.from({ length: 30 }, (_, i) => {
        const date = new Date();
        date.setDate(date.getDate() - (29 - i));
        return {
          key: date.toISOString().split('T')[0],
          count: Math.floor(Math.random() * 200) + 20
        };
      });

      const bySentiment = sentiments.map(sentiment => ({
        key: sentiment,
        count: Math.floor(Math.random() * 1500) + 200
      }));

      const byUrgency = urgencies.map(urgency => ({
        key: urgency,
        count: Math.floor(Math.random() * 800) + 100
      }));

      const byValue = values.map(value => ({
        key: value,
        count: Math.floor(Math.random() * 1000) + 300
      }));

      return {
        totalCount,
        byTheme,
        byPlatform,
        byCountry,
        byProduct,
        byTime,
        bySentiment,
        byUrgency,
        byValue
      };
    };

    // Chart instances storage
    const chartInstances = {};
    
    // Store last applied filters to prevent unnecessary updates
    let lastAppliedFilters = null;

    // Create chart helper
    const createChart = (canvasId, type, data, options = {}) => {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return null;

      // Destroy existing chart if any
      if (chartInstances[canvasId]) {
        chartInstances[canvasId].destroy();
      }

      const ctx = canvas.getContext('2d');
      const defaultOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 15,
              font: {
                size: 12
              }
            }
          },
          tooltip: {
            enabled: true
          }
        }
      };

      const chartOptions = { ...defaultOptions, ...options };
      const chart = new Chart(ctx, {
        type,
        data,
        options: chartOptions
      });

      chartInstances[canvasId] = chart;
      return chart;
    };

    // Generate chart colors
    const getChartColors = (count) => {
      const baseColors = [
        '#F6821F', '#FF9A3C', '#FFB366', '#FFCC99', '#FFE5CC',
        '#E6730F', '#FF8C42', '#FFA366', '#FFB88C', '#FFD4B3'
      ];
      const colors = [];
      for (let i = 0; i < count; i++) {
        colors.push(baseColors[i % baseColors.length]);
      }
      return colors;
    };

    // Render stats overview
    const renderStatsOverview = (data) => {
      const statsContainer = document.getElementById('statsOverview');
      
      // Calculate sentiment score
      const positiveCount = data.bySentiment.find(s => s.key === 'positive')?.count || 0;
      const totalSentiment = data.bySentiment.reduce((sum, s) => sum + (s.count || 0), 0);
      const sentimentScore = totalSentiment > 0 ? ((positiveCount / totalSentiment) * 100).toFixed(0) : 0;
      
      // Calculate average urgency
      const urgencyCounts = {
        critical: data.byUrgency.find(u => u.key === 'critical')?.count || 0,
        high: data.byUrgency.find(u => u.key === 'high')?.count || 0,
        medium: data.byUrgency.find(u => u.key === 'medium')?.count || 0,
        low: data.byUrgency.find(u => u.key === 'low')?.count || 0
      };
      const totalUrgency = Object.values(urgencyCounts).reduce((a, b) => a + b, 0);
      let avgUrgency = 'Medium';
      if (totalUrgency > 0) {
        const criticalRatio = urgencyCounts.critical / totalUrgency;
        const highRatio = urgencyCounts.high / totalUrgency;
        if (criticalRatio > 0.2) avgUrgency = 'Critical';
        else if (highRatio > 0.3) avgUrgency = 'High';
        else if (urgencyCounts.low / totalUrgency > 0.5) avgUrgency = 'Low';
      }
      
      statsContainer.innerHTML = `
        <div class="stat-card">
          <h3>Total Feedback</h3>
          <div class="value">${(data.totalCount || 0).toLocaleString()}</div>
          <div class="change">‚Üë Active feedback count</div>
        </div>
        <div class="stat-card">
          <h3>Unique Themes</h3>
          <div class="value">${(data.byTheme || []).length}</div>
          <div class="change">‚Üë Identified themes</div>
        </div>
        <div class="stat-card">
          <h3>Avg. Urgency</h3>
          <div class="value">${avgUrgency}</div>
          <div class="change">${urgencyCounts.critical > 0 ? `‚ö† ${urgencyCounts.critical} critical issues` : '‚Üì No critical issues'}</div>
        </div>
        <div class="stat-card">
          <h3>Sentiment Score</h3>
          <div class="value">${sentimentScore}%</div>
          <div class="change">‚Üë ${positiveCount} positive feedbacks</div>
        </div>
      `;
    };

    // Render all charts
    const renderCharts = (data) => {
      // Destroy all existing charts first to ensure fresh render
      if (typeof chartInstances !== 'undefined') {
        Object.keys(chartInstances).forEach(chartId => {
          if (chartInstances[chartId]) {
            chartInstances[chartId].destroy();
            delete chartInstances[chartId];
          }
        });
      }
      
      const chartsGrid = document.getElementById('chartsGrid');
      
      chartsGrid.innerHTML = `
        <!-- Theme Distribution -->
        <div class="chart-card">
          <div class="chart-card-header">
          <h3>Feedback by Theme</h3>
            <div class="chart-actions">
              <button class="btn-icon" onclick="copyChart('chartTheme', 'Feedback by Theme', event)" title="Copy chart as image">üìã</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="chartTheme"></canvas>
          </div>
        </div>

        <!-- Platform Distribution -->
        <div class="chart-card">
          <div class="chart-card-header">
          <h3>Feedback by Platform</h3>
            <div class="chart-actions">
              <button class="btn-icon" onclick="copyChart('chartPlatform', 'Feedback by Platform', event)" title="Copy chart as image">üìã</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="chartPlatform"></canvas>
          </div>
        </div>

        <!-- Country Distribution -->
        <div class="chart-card">
          <div class="chart-card-header">
          <h3>Feedback by Country</h3>
            <div class="chart-actions">
              <button class="btn-icon" onclick="copyChart('chartCountry', 'Feedback by Country', event)" title="Copy chart as image">üìã</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="chartCountry"></canvas>
          </div>
        </div>

        <!-- Product Distribution -->
        <div class="chart-card">
          <div class="chart-card-header">
          <h3>Feedback by Product</h3>
            <div class="chart-actions">
              <button class="btn-icon" onclick="copyChart('chartProduct', 'Feedback by Product', event)" title="Copy chart as image">üìã</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="chartProduct"></canvas>
          </div>
        </div>

        <!-- Time Series -->
        <div class="chart-card full-width">
          <div class="chart-card-header">
          <h3>Feedback Over Time</h3>
            <div class="chart-actions">
              <button class="btn-icon" onclick="copyChart('chartTime', 'Feedback Over Time', event)" title="Copy chart as image">üìã</button>
            </div>
          </div>
          <div class="chart-container large">
            <canvas id="chartTime"></canvas>
          </div>
        </div>

        <!-- Sentiment Analysis -->
        <div class="chart-card">
          <div class="chart-card-header">
          <h3>Sentiment Analysis</h3>
            <div class="chart-actions">
              <button class="btn-icon" onclick="copyChart('chartSentiment', 'Sentiment Analysis', event)" title="Copy chart as image">üìã</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="chartSentiment"></canvas>
          </div>
        </div>

        <!-- Urgency Distribution -->
        <div class="chart-card">
          <div class="chart-card-header">
          <h3>Urgency Levels</h3>
            <div class="chart-actions">
              <button class="btn-icon" onclick="copyChart('chartUrgency', 'Urgency Levels', event)" title="Copy chart as image">üìã</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="chartUrgency"></canvas>
          </div>
        </div>

        <!-- Value Assessment -->
        <div class="chart-card">
          <div class="chart-card-header">
          <h3>Value Assessment</h3>
            <div class="chart-actions">
              <button class="btn-icon" onclick="copyChart('chartValue', 'Value Assessment', event)" title="Copy chart as image">üìã</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="chartValue"></canvas>
          </div>
        </div>
      `;

      // Create Theme Chart (Pie)
      setTimeout(() => {
        if (data.byTheme && data.byTheme.length > 0) {
          const canvas = document.getElementById('chartTheme');
          if (canvas) {
            createChart('chartTheme', 'pie', {
              labels: data.byTheme.map(d => d.key),
              datasets: [{
                data: data.byTheme.map(d => d.count),
                backgroundColor: getChartColors(data.byTheme.length),
                borderWidth: 2,
                borderColor: '#FFFFFF'
              }]
            });
          }
        }
      }, 200);

      // Create Platform Chart (Doughnut)
      setTimeout(() => {
        if (data.byPlatform && data.byPlatform.length > 0) {
          const canvas = document.getElementById('chartPlatform');
          if (canvas) {
            createChart('chartPlatform', 'doughnut', {
              labels: data.byPlatform.map(d => d.key.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())),
              datasets: [{
                data: data.byPlatform.map(d => d.count),
                backgroundColor: getChartColors(data.byPlatform.length),
                borderWidth: 2,
                borderColor: '#FFFFFF'
              }]
            });
          }
        }
      }, 300);

      // Create Country Chart (Bar)
      setTimeout(() => {
        if (data.byCountry && data.byCountry.length > 0) {
          const canvas = document.getElementById('chartCountry');
          if (canvas) {
            createChart('chartCountry', 'bar', {
              labels: data.byCountry.map(d => d.key),
              datasets: [{
                label: 'Feedback Count',
                data: data.byCountry.map(d => d.count),
                backgroundColor: getChartColors(data.byCountry.length),
                borderRadius: 8
              }]
            }, {
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    precision: 0
                  }
                }
              }
            });
          }
        }
      }, 400);

      // Create Product Chart (Bar - Horizontal)
      setTimeout(() => {
        if (data.byProduct && data.byProduct.length > 0) {
          const canvas = document.getElementById('chartProduct');
          if (canvas) {
            createChart('chartProduct', 'bar', {
              labels: data.byProduct.map(d => d.key),
              datasets: [{
                label: 'Feedback Count',
                data: data.byProduct.map(d => d.count),
                backgroundColor: getChartColors(data.byProduct.length),
                borderRadius: 8
              }]
            }, {
              indexAxis: 'y',
              scales: {
                x: {
                  beginAtZero: true,
                  ticks: {
                    precision: 0
                  }
                }
              }
            });
          }
        }
      }, 500);

      // Create Time Series Chart (Line)
      setTimeout(() => {
        if (data.byTime && data.byTime.length > 0) {
          const canvas = document.getElementById('chartTime');
          if (canvas) {
            createChart('chartTime', 'line', {
              labels: data.byTime.map(d => {
                const date = new Date(d.key);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
              }),
              datasets: [{
                label: 'Daily Feedback',
                data: data.byTime.map(d => d.count),
                borderColor: '#F6821F',
                backgroundColor: 'rgba(246, 130, 31, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: '#F6821F',
                pointBorderColor: '#FFFFFF',
                pointBorderWidth: 2
              }]
            }, {
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    precision: 0
                  }
                }
              }
            });
          }
        }
      }, 600);

      // Create Sentiment Chart (Pie) - Higher contrast colors
      setTimeout(() => {
        if (data.bySentiment && data.bySentiment.length > 0) {
          const canvas = document.getElementById('chartSentiment');
          if (canvas) {
            // Use higher contrast colors for better distinction
            const sentimentColors = {
              'positive': '#10B981',  // Green (success)
              'neutral': '#6B7280',   // Gray
              'negative': '#EF4444'   // Red (error)
            };
            createChart('chartSentiment', 'pie', {
              labels: data.bySentiment.map(d => d.key.charAt(0).toUpperCase() + d.key.slice(1)),
              datasets: [{
                data: data.bySentiment.map(d => d.count),
                backgroundColor: data.bySentiment.map(d => sentimentColors[d.key] || '#6B7280'),
                borderWidth: 2,
                borderColor: '#FFFFFF'
              }]
            });
          }
        }
      }, 700);

      // Create Urgency Chart (Bar) - Higher contrast colors
      setTimeout(() => {
        if (data.byUrgency && data.byUrgency.length > 0) {
          const canvas = document.getElementById('chartUrgency');
          if (canvas) {
            const urgencyColors = {
              'low': '#10B981',      // Green (low priority)
              'medium': '#F59E0B',   // Amber (medium priority)
              'high': '#F6821F',     // Orange (high priority)
              'critical': '#EF4444'  // Red (critical)
            };
            createChart('chartUrgency', 'bar', {
              labels: data.byUrgency.map(d => d.key.charAt(0).toUpperCase() + d.key.slice(1)),
              datasets: [{
                label: 'Feedback Count',
                data: data.byUrgency.map(d => d.count),
                backgroundColor: data.byUrgency.map(d => urgencyColors[d.key] || '#F59E0B'),
                borderRadius: 8
              }]
            }, {
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    precision: 0
                  }
                }
              }
            });
          }
        }
      }, 800);

      // Create Value Chart (Doughnut) - Higher contrast colors
      setTimeout(() => {
        if (data.byValue && data.byValue.length > 0) {
          const canvas = document.getElementById('chartValue');
          if (canvas) {
            const valueColors = {
              'low': '#94A3B8',    // Slate gray (low value)
              'medium': '#F59E0B',  // Amber (medium value)
              'high': '#10B981'     // Green (high value)
            };
            createChart('chartValue', 'doughnut', {
              labels: data.byValue.map(d => d.key.charAt(0).toUpperCase() + d.key.slice(1)),
              datasets: [{
                data: data.byValue.map(d => d.count),
                backgroundColor: data.byValue.map(d => valueColors[d.key] || '#F59E0B'),
                borderWidth: 2,
                borderColor: '#FFFFFF'
              }]
            });
          }
        }
      }, 900);
    };


    // Multi-select functions
    let activeDropdown = null;

    function toggleMultiSelect(type) {
      const dropdown = document.getElementById(`${type}Dropdown`);
      
      // Close other dropdowns
      document.querySelectorAll('.multi-select-dropdown').forEach(dd => {
        if (dd !== dropdown) {
          dd.classList.remove('active');
        }
      });
      
      // Toggle current dropdown
      dropdown.classList.toggle('active');
      activeDropdown = dropdown.classList.contains('active') ? dropdown : null;
    }

    function updateMultiSelect(type) {
      const checkboxes = document.querySelectorAll(`input[name="${type}"]:checked`);
      const displayText = document.getElementById(`${type}DisplayText`);
      const selectedValues = Array.from(checkboxes).map(cb => cb.value);
      
      if (selectedValues.length === 0) {
        displayText.textContent = `All ${type === 'product' ? 'Products' : type === 'platform' ? 'Platforms' : 'Countries'}`;
      } else if (selectedValues.length === 1) {
        displayText.textContent = selectedValues[0];
      } else {
        displayText.textContent = `${selectedValues.length} selected`;
      }
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (activeDropdown && !activeDropdown.contains(e.target) && 
          !e.target.closest('.multi-select-display')) {
        activeDropdown.classList.remove('active');
        activeDropdown = null;
      }
    });

    // Get current filters
    const getFilters = () => {
      // Get selected products
      const productCheckboxes = document.querySelectorAll('input[name="product"]:checked');
      const products = Array.from(productCheckboxes).map(cb => cb.value);
      
      // Get selected platforms
      const platformCheckboxes = document.querySelectorAll('input[name="platform"]:checked');
      const platforms = Array.from(platformCheckboxes).map(cb => cb.value);
      
      // Get selected countries
      const countryCheckboxes = document.querySelectorAll('input[name="country"]:checked');
      const countries = Array.from(countryCheckboxes).map(cb => cb.value);
      
      return {
        product: products.length > 0 ? products.join(',') : '',
        platform: platforms.length > 0 ? platforms.join(',') : '',
        country: countries.length > 0 ? countries.join(',') : '',
        timeRange: document.getElementById('filterTimeRange').value || '30'
      };
    };

    // Apply filters and update dashboard
    const updateDashboard = async () => {
      const filters = getFilters();
      
      // Check if filters have changed
      const filtersString = JSON.stringify(filters);
      if (lastAppliedFilters === filtersString) {
        // Filters haven't changed, no need to update
        return;
      }
      
      // Update last applied filters
      lastAppliedFilters = filtersString;
      
      const loading = document.getElementById('loading');
      loading.classList.add('active');

      try {
        // Build query parameters
        const params = new URLSearchParams();
        if (filters.timeRange) params.set('timeRange', filters.timeRange);
        if (filters.product) params.set('product', filters.product);
        if (filters.platform) params.set('platform', filters.platform);
        if (filters.country) params.set('country', filters.country);

        // Fetch data from API
        const response = await fetch(`/api/query?${params.toString()}`);
        const result = await response.json();

        if (!result.ok) {
          throw new Error(result.error || 'Failed to fetch data');
        }

        // Transform API response to match expected format
        const data = {
          totalCount: result.totalCount || 0,
          byTheme: result.charts.byTheme || [],
          byPlatform: result.charts.byPlatform || [],
          byCountry: result.charts.byCountry || [],
          byProduct: result.charts.byProduct || [],
          byTime: result.charts.byTime || [],
          bySentiment: result.charts.bySentiment || [],
          byUrgency: result.charts.byUrgency || [],
          byValue: result.charts.byValue || []
        };
        
        renderStatsOverview(data);
        renderCharts(data);
        
      } catch (error) {
        console.error('Error fetching data:', error);
        // Fallback to mock data on error
        const data = generateMockData(filters);
        renderStatsOverview(data);
        renderCharts(data);
        alert('Error loading data. Showing mock data instead.');
      } finally {
        loading.classList.remove('active');
      }
    };

    // Generate AI Advice
    const generateAIAdvice = async () => {
      const adviceSection = document.getElementById('aiAdviceSection');
      const adviceContent = document.getElementById('aiAdviceContent');
      
      // Show loading state
      adviceContent.innerHTML = '<div class="spinner"></div><p>Generating AI recommendations...</p>';
      adviceSection.classList.add('active');

      try {
      const filters = getFilters();
        
        // First get current chart data
        const params = new URLSearchParams();
        if (filters.timeRange) params.set('timeRange', filters.timeRange);
        if (filters.products) params.set('products', filters.products);
        if (filters.platforms) params.set('platforms', filters.platforms);
        if (filters.countries) params.set('countries', filters.countries);
        if (filters.keyword) params.set('keyword', filters.keyword);
        if (filters.dateFrom) params.set('dateFrom', filters.dateFrom);
        if (filters.dateTo) params.set('dateTo', filters.dateTo);

        const queryResponse = await fetch(`/api/query?${params.toString()}`);
        const queryResult = await queryResponse.json();

        if (!queryResult.ok) {
          throw new Error('Failed to fetch chart data');
        }

        // Request AI advice
        const aiResponse = await fetch('/api/ai-advice', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            filters,
            chartData: {
              totalCount: queryResult.totalCount,
              ...queryResult.charts
            }
          })
        });

        const aiResult = await aiResponse.json();

        if (!aiResult.ok) {
          throw new Error(aiResult.error || 'Failed to generate AI advice');
        }

        // Display AI advice
        let adviceHTML = aiResult.advice.map(item => `
        <div class="advice-item">
          <strong>${item.title}</strong>
          <div>${item.text}</div>
        </div>
      `).join('');

        // Show quota warning if fallback was used
        if (aiResult.fallback) {
          adviceHTML = `
            <div class="advice-item" style="background: #FFF3E0; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
              <strong style="color: #F6821F;">‚ö†Ô∏è Using Fallback Recommendations</strong>
              <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                ${aiResult.error && aiResult.error.includes('quota') 
                  ? 'AI service limit reached. Showing rule-based recommendations.' 
                  : 'AI service unavailable. Showing rule-based recommendations.'}
              </div>
            </div>
          ` + adviceHTML;
        }
        
        adviceContent.innerHTML = adviceHTML;

      } catch (error) {
        console.error('Error generating AI advice:', error);
        const errorMessage = error.message || String(error);
        const isQuotaError = errorMessage.includes('limit') || errorMessage.includes('quota') || errorMessage.includes('exceeded');
        
        adviceContent.innerHTML = `
          <div class="advice-item">
            <strong>${isQuotaError ? 'AI Service Limit Reached' : 'Error'}</strong>
            <div>${isQuotaError 
              ? 'Workers AI daily limit has been reached. Please upgrade your plan or try again tomorrow.' 
              : `Failed to generate AI recommendations: ${errorMessage}`}</div>
            <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
              Using fallback recommendations based on data analysis.
            </div>
          </div>
        `;
        // Still show the section even on error
      adviceSection.classList.add('active');
      }
    };

    // Save View
    const saveView = async () => {
      try {
      const filters = getFilters();
        const name = prompt('Enter a name for this view:', `View ${new Date().toLocaleString()}`);
        
        if (!name) return; // User cancelled

        console.log('Saving view with filters:', filters);

        const response = await fetch('/api/save-view', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
        filters,
            name
          })
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Save view response error:', response.status, errorText);
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const result = await response.json();
        console.log('Save view result:', result);

        if (!result.ok) {
          throw new Error(result.error || 'Failed to save view');
        }

        alert(`View "${name}" saved successfully!`);
      } catch (error) {
        console.error('Error saving view:', error);
        alert(`Error saving view: ${error.message}. Please check the console for details.`);
      }
    };

    // Share Link
    const shareLink = () => {
      const filters = getFilters();
      const params = new URLSearchParams();
      Object.entries(filters).forEach(([key, value]) => {
        if (value) params.set(key, value);
      });
      
      const shareUrl = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
      
      // Show share menu with copy and share options
      showShareMenu(shareUrl);
    };

    // Show share menu with copy and share options
    const showShareMenu = (url) => {
      // Remove existing menu if any
      const existingMenu = document.querySelector('.share-menu');
      if (existingMenu) existingMenu.remove();

      // Create menu element
      const menu = document.createElement('div');
      menu.className = 'share-menu';
      menu.innerHTML = `
        <div class="share-menu-content">
          <div class="share-menu-header">
            <h4>Share Link</h4>
            <button class="share-menu-close" onclick="this.closest('.share-menu').remove()">√ó</button>
          </div>
          <div class="share-menu-url">
            <input type="text" value="${url}" readonly id="shareUrlInput">
            <button class="btn-copy-url" onclick="copyShareUrl('${url.replace(/'/g, "\\'")}')">üìã Copy</button>
          </div>
          <div class="share-menu-actions">
            ${navigator.share ? `
              <button class="btn-share-native" onclick="nativeShare('${url.replace(/'/g, "\\'")}')">
                üì§ Share via...
              </button>
            ` : ''}
          </div>
        </div>
      `;
      
      // Add styles if not already added
      if (!document.getElementById('share-menu-styles')) {
        const style = document.createElement('style');
        style.id = 'share-menu-styles';
        style.textContent = `
          .share-menu {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.2s;
          }
          .share-menu-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.3s;
          }
          .share-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
          }
          .share-menu-header h4 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
          }
          .share-menu-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
          }
          .share-menu-close:hover {
            background: var(--bg-secondary);
          }
          .share-menu-url {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
          }
          .share-menu-url input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
          }
          .btn-copy-url {
            padding: 10px 16px;
            background: var(--cf-orange);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
          }
          .btn-copy-url:hover {
            background: var(--cf-orange-dark);
          }
          .share-menu-actions {
            display: flex;
            gap: 8px;
          }
          .btn-share-native {
            flex: 1;
            padding: 10px 16px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
          }
          .btn-share-native:hover {
            background: var(--border-color);
          }
          @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
          }
          @keyframes slideUp {
            from {
              transform: translateY(20px);
              opacity: 0;
            }
            to {
              transform: translateY(0);
              opacity: 1;
            }
          }
        `;
        document.head.appendChild(style);
      }
      
      // Add click outside to close
      menu.addEventListener('click', (e) => {
        if (e.target === menu) {
          menu.remove();
        }
      });
      
      document.body.appendChild(menu);
      
      // Focus and select URL input
      setTimeout(() => {
        const input = menu.querySelector('#shareUrlInput');
        if (input) {
          input.focus();
          input.select();
        }
      }, 100);
    };

    // Copy share URL
    window.copyShareUrl = (url) => {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => {
          const btn = document.querySelector('.btn-copy-url');
          if (btn) {
            const originalText = btn.textContent;
            btn.textContent = '‚úì Copied!';
            btn.style.background = 'var(--success)';
            setTimeout(() => {
              btn.textContent = originalText;
              btn.style.background = '';
            }, 2000);
          }
        }).catch(() => {
          // Fallback: select text
          const input = document.getElementById('shareUrlInput');
          if (input) {
            input.select();
            input.setSelectionRange(0, 99999);
            alert('URL selected. Press Ctrl+C (or Cmd+C) to copy.');
          }
        });
      } else {
        // Fallback: select text
        const input = document.getElementById('shareUrlInput');
        if (input) {
          input.select();
          input.setSelectionRange(0, 99999);
          alert('URL selected. Press Ctrl+C (or Cmd+C) to copy.');
        }
      }
    };

    // Native share
    window.nativeShare = (url) => {
      if (navigator.share) {
        navigator.share({
          title: 'Feedback Insights Dashboard',
          text: 'Check out this feedback analysis view',
          url: url
        }).then(() => {
          document.querySelector('.share-menu')?.remove();
        }).catch(() => {
          // User cancelled or error
        });
      }
    };

    // Copy chart as image
    window.copyChart = async function(chartId, chartName, evt) {
      const event = evt || window.event;
      const btn = event ? event.target : null;
      
      try {
        const canvas = document.getElementById(chartId);
        if (!canvas) {
          alert('Chart not found');
          return;
        }

        // Convert canvas to data URL
        const dataURL = canvas.toDataURL('image/png');
        
        // Try modern Clipboard API first
        try {
          if (navigator.clipboard && navigator.clipboard.write) {
            // Convert data URL to blob
            const response = await fetch(dataURL);
            const blob = await response.blob();
            
            // Try ClipboardItem if available
            if (typeof ClipboardItem !== 'undefined') {
              const item = new ClipboardItem({ 'image/png': blob });
              await navigator.clipboard.write([item]);
              
              // Success feedback
              if (btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úì';
                btn.style.color = 'var(--success)';
                setTimeout(() => {
                  btn.innerHTML = originalText;
                  btn.style.color = '';
                }, 2000);
              }
              return;
            }
          }
        } catch (e) {
          console.log('Modern clipboard API failed, trying fallback:', e);
        }
        
        // Fallback: Create temporary image and copy
        const img = document.createElement('img');
        img.src = dataURL;
        img.style.position = 'fixed';
        img.style.left = '-9999px';
        img.style.top = '-9999px';
        document.body.appendChild(img);
        
        // Wait for image to load
        await new Promise((resolve) => {
          if (img.complete) {
            resolve();
          } else {
            img.onload = resolve;
            img.onerror = resolve; // Continue even on error
          }
        });
        
        // Select and copy
        const range = document.createRange();
        range.selectNode(img);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        
        const success = document.execCommand('copy');
        selection.removeAllRanges();
        document.body.removeChild(img);
        
        if (success) {
          if (btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úì';
            btn.style.color = 'var(--success)';
            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.style.color = '';
            }, 2000);
          }
        } else {
          throw new Error('Copy command failed');
        }
      } catch (error) {
        console.error('Copy error:', error);
        alert('ÁÑ°Ê≥ïË§áË£ΩÂúñË°®„ÄÇË´ãÂòóË©¶Âè≥ÈçµÈªûÊìäÂúñË°®‰∏¶ÈÅ∏Êìá„ÄåË§áË£ΩÂúñÁâá„Äç„ÄÇ\n\nUnable to copy chart. Please try right-clicking the chart and selecting "Copy image".');
      }
    };

    // Load filters from URL
    const loadFiltersFromURL = () => {
      const params = new URLSearchParams(window.location.search);
      
      if (params.get('timeRange')) {
        document.getElementById('filterTimeRange').value = params.get('timeRange');
      }
      
      // Load products
      if (params.get('product')) {
        const products = params.get('product').split(',');
        // Uncheck all first
        document.querySelectorAll('input[name="product"]').forEach(cb => cb.checked = false);
        // Check selected ones
        products.forEach(product => {
          const checkbox = document.querySelector(`input[name="product"][value="${product.trim()}"]`);
          if (checkbox) checkbox.checked = true;
        });
        updateMultiSelect('product');
      }
      
      // Load platforms
      if (params.get('platform')) {
        const platforms = params.get('platform').split(',');
        // Uncheck all first
        document.querySelectorAll('input[name="platform"]').forEach(cb => cb.checked = false);
        // Check selected ones
        platforms.forEach(platform => {
          const checkbox = document.querySelector(`input[name="platform"][value="${platform.trim()}"]`);
          if (checkbox) checkbox.checked = true;
        });
        updateMultiSelect('platform');
      }
      
      // Load countries
      if (params.get('country')) {
        const countries = params.get('country').split(',');
        // Uncheck all first
        document.querySelectorAll('input[name="country"]').forEach(cb => cb.checked = false);
        // Check selected ones
        countries.forEach(country => {
          const checkbox = document.querySelector(`input[name="country"][value="${country.trim()}"]`);
          if (checkbox) checkbox.checked = true;
        });
        updateMultiSelect('country');
      }
    };

    // Close AI Advice
    const closeAIAdvice = () => {
      const adviceSection = document.getElementById('aiAdviceSection');
      adviceSection.classList.remove('active');
    };




    // Event Listeners
    document.getElementById('btnApplyFilters').addEventListener('click', updateDashboard);
    document.getElementById('btnSaveView').addEventListener('click', saveView);
    document.getElementById('btnShare').addEventListener('click', shareLink);
    document.getElementById('btnAIAdvice').addEventListener('click', generateAIAdvice);
    document.getElementById('btnCloseAI').addEventListener('click', closeAIAdvice);

    // Initialize - Load filters from URL first, then update dashboard
    loadFiltersFromURL();
    
    // Initialize multi-select display text (ensure "All" is shown when nothing is selected)
    setTimeout(() => {
      updateMultiSelect('product');
      updateMultiSelect('platform');
      updateMultiSelect('country');
    }, 50);
    
    // Wait for DOM to be fully ready, then load initial data
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
          updateMultiSelect('product');
          updateMultiSelect('platform');
          updateMultiSelect('country');
          updateDashboard();
        }, 100);
      });
    } else {
      // DOM already loaded, update immediately
      setTimeout(() => {
        updateMultiSelect('product');
        updateMultiSelect('platform');
        updateMultiSelect('country');
        updateDashboard();
      }, 100);
    }
  </script>
</body>
</html>
